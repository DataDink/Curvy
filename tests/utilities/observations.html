<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Observation Tests</title>
		<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">
		<script src="../../builds/curvy.js"></script>
	</head>
	<body>
		<div id="qunit"></div>
		<div id="qunit-fixture"></div>
		<script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
		<script>
			Application.extend(function(utilities, application) {
				QUnit.test('Path', function(assert) {
					var observe = { 
						a: { b: { c: {} } },
						d: { e: { f: {} } }
					};
					
					assert.ok(!!utilities.path(observe, 'a'), 'a');
					assert.ok(!!utilities.path(observe, 'a.b'), 'a.b');
					assert.ok(!!utilities.path(observe, 'a.b.c'), 'a.b.c');
					assert.ok(!!utilities.path(observe, 'd'), 'd');
					assert.ok(!!utilities.path(observe, 'd.e'), 'd.e');
					assert.ok(!!utilities.path(observe, 'd.e.f'), 'd.e.f');
					
					assert.ok(!utilities.path(observe, 'b'), 'b');
					assert.ok(!utilities.path(observe, 'b.a'), 'b.a');
					assert.ok(!utilities.path(observe, 'b.c'), 'b.c');
					assert.ok(!utilities.path(observe, 'e'), 'e');
					assert.ok(!utilities.path(observe, 'e.d'), 'e.d');
					assert.ok(!utilities.path(observe, 'e.f'), 'e.f');
					
					assert.ok(!utilities.path(observe, 'a.e'), 'a.e');
				});
				
				QUnit.test('Watch', function(assert) {
					function create() {
						return application.Observable.convert({
							a: application.Observable.convert({ b: { c: {} } }),
							d: application.Observable.convert({ e: { f: {} } })
						});
					}
					
					var observeCount = 0;
					var observe = create();
					var result = false;
					utilities.watch(observe, 'a', function() {
						assert.ok(result, 'a');
						observeCount++;
					});
					observe.a.b.c = true;
					observe.a.b = true;
					observe.d = true;
					result = true;
					observe.a = true;
					assert.strictEqual(observeCount, 1, '1 observation');
					
					var observeCount = 0;
					var observe = create();
					var result = false;
					utilities.watch(observe, 'a.b', function() {
						assert.ok(result, 'a.b');
						observeCount++;
					});
					observe.a.b.c = true;
					result = true;
					observe.a.b = true;
					observe.a = {}; // b gets set to nothing
					result = false;
					observe.a.b = true;
					result = true;
					observe.a = application.Observable.convert({ b: true });
					observe.a.b = true;
					assert.strictEqual(observeCount, 4, '4 observations');
				});
				
				QUnit.test('Watch Disposal', function(assert) {
					var base = application.Observable.convert({
						child: application.Observable.convert({ value: true })
					});
					var child = base.child;
					
					var result = false;
					var count = 0;
					var disposal = utilities.watch(base, 'child.value', function() {
						assert.ok(result, 'base->child->value');
						count++;
					});
					result = true;
					child.value = true;
					base.child = true;
					result = false;
					child.value = true;
					result = true;
					base.child = child;
					child.value = true;
					result = false;
					disposal();
					child.value = true;
					assert.strictEqual(count, 4, '4 observations');
				});
			});
			new Application();
		</script>
	</body>
</html>