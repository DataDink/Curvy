<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Basic</title>
		<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">
		<script src="../../builds/curvy.js"></script>
	</head>
	<body>

		<div data-binding></div>

		<div id="qunit"></div>
		<div id="qunit-fixture"></div>
		<script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
		<script>
			var notdisposed = 0;
			var viewdisposed = 0;
			var listendisposed = 0;
			var wrongchannel = 0;
			Application.extend.binding('data-binding', function(view, broadcast) {
				broadcast.subscribe('WrongChannel', function() { wrongchannel++; });
				broadcast.subscribe('Channel', function() { notdisposed++; });
				var responder = function() { viewdisposed++; };
				broadcast.subscribe('Channel', responder);
				view.dispose = function() { broadcast.unsubscribe(responder); };
				view.listen('Channel', function() { listendisposed++; });
			});

			Application.extend(function(broadcast, application) {
				application.bcast = broadcast;
			});

			var app = new Application();

			setTimeout(function() {
				app.bcast.send('Channel');
				var element = document.querySelector('[data-binding]');
				element.parentNode.removeChild(element);

				setTimeout(function() {
					app.bcast.send('Channel');

					QUnit.test('Tests', function(assert) {
						assert.strictEqual(notdisposed, 2, 'Not disposed');
						assert.strictEqual(viewdisposed, 1, 'View disposed');
						assert.strictEqual(listendisposed, 1, 'Listen disposed');
						assert.strictEqual(wrongchannel, 0, 'Wrong channel');
					});
				}, 10);
			}, 10);
		</script>
	</body>
</html>
